<!DOCTYPE html>
<html lang="en">

<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163094446-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-163094446-1');
	</script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="api-gateway-flow-control" />
	<meta name="description" content="api-gateway-flow-control" />
	<!-- 网页标签标题 -->
	<title>api-gateway-flow-control</title>
	<link rel="shortcut icon" href="/img/sentinel.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><img class="logo" src="/img/sentinel_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/en-us/index.html" target="_self">HOME</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/en-us/docs/introduction.html" target="_self">DOCS</a></li><li class="menu-item menu-item-normal"><a href="/en-us/docs/developers/developers_dev.html" target="_self">DEVELOPERS</a></li><li class="menu-item menu-item-normal"><a href="/en-us/blog/index.html" target="_self">BLOG</a></li><li class="menu-item menu-item-normal"><a href="/en-us/community/index.html" target="_self">COMMUNITY</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>Documentation</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Overview</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/introduction.html" target="_self">Introduction to Sentinel</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/quick-start.html" target="_self">Quick Start</a></li></ul></li><li class="menu-item menu-item-level-1"><span>User Guide</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/basic-implementation.html" target="_self">How Sentinel Works</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/basic-api-resource-rule.html" target="_self">API Guide (resource and rule)</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/flow-control.html" target="_self">Flow Control</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/parameter-flow-control.html" target="_self">Parameter Flow Control</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/cluster-flow-control.html" target="_self">Cluster Flow Control</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/api-gateway-flow-control.html" target="_self">API Gateway Flow Control</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/circuit-breaking.html" target="_self">Circuit Breaking</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/system-adaptive-protection.html" target="_self">System Adaptive Protection</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/open-source-framework-integrations.html" target="_self">Microservice Framework Integrations</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/dashboard.html" target="_self">Dashboard</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/general-configuration.html" target="_self">General Configuration</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/logs.html" target="_self">Logs</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>API Gateway Flow Control</h1>
<p>Sentinel supports flow control for API gateways including Spring Cloud Gateway and Zuul 1.x.</p>
<p><img src="https://user-images.githubusercontent.com/9434884/70883552-4ce61700-200e-11ea-8324-e803d0753a20.png" alt="image"></p>
<p>Sentinel 1.6.0 introduced the <code>sentinel-api-gateway-adapter-common</code> module, which includes common management logic for gateway rules and customized API groups.</p>
<ul>
<li><code>GatewayFlowRule</code>: The flow rule specifically designed for API gateway, enabling flow control for different routes or customized API groups. It also supports flow control by request attributes (e.g. HTTP header, client IP and URL parameters).</li>
<li><code>ApiDefinition</code>: The user-defined API group, which can be regarded as a group of URL patterns.</li>
</ul>
<h2>Spring Cloud Gateway</h2>
<p>Sentinel provides the integration module with Spring Cloud Gateway, providing two levels of flow control:</p>
<ul>
<li>Route level: flow control for defined routes in Spring properties file.</li>
<li>Customized API group level: flow control for customized API groups defined in <code>GatewayApiDefinitionManager</code> of Sentinel.</li>
</ul>
<p>Add the following dependency in <code>pom.xml</code> (if you are using Maven):</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>x.y.z<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>Then you only need to inject the corresponding <code>SentinelGatewayFilter</code> and <code>SentinelGatewayBlockExceptionHandler</code> instance
in Spring configuration. For example:</p>
<pre><code class="language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GatewayConfiguration</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GatewayConfiguration</span><span class="hljs-params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,
                                ServerCodecConfigurer serverCodecConfigurer)</span> </span>{
        <span class="hljs-keyword">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        <span class="hljs-keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Order</span>(-<span class="hljs-number">1</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="hljs-title">sentinelGatewayBlockExceptionHandler</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Register the block exception handler for Spring Cloud Gateway.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title">sentinelGatewayFilter</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// By default the order is HIGHEST_PRECEDENCE</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelGatewayFilter();
    }
}
</code></pre>
<p>The gateway adapter will regard all <code>routeId</code> (defined in Spring properties) and all customized API definitions
(defined in <code>GatewayApiDefinitionManager</code> of <code>sentinel-api-gateway-adapter-common</code> module) as resources.</p>
<p>You can register various kinds of customized callback in <code>GatewayCallbackManager</code>:</p>
<ul>
<li><code>setBlockHandler</code>: register a customized <code>BlockRequestHandler</code> to handle the blocked request. The default implementation is <code>DefaultBlockRequestHandler</code>, which returns default message like <code>Blocked by Sentinel: FlowException</code>.</li>
</ul>
<h2>Zuul 1.x</h2>
<p>Sentinel provides the integration module with Zuul 1.x, providing two levels of flow control:</p>
<ul>
<li>Route level: flow control for defined routes in Zuul properties file.</li>
<li>Customized API group level: flow control for customized API groups defined in <code>GatewayApiDefinitionManager</code> of Sentinel.</li>
</ul>
<p>To introduce Sentinel to your Zuul gateway, add the following dependency in <code>pom.xml</code> (if you are using Maven):</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-zuul-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>x.y.z<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>Then for Spring Cloud Zuul users, we only need to inject the three filters in Spring configuration class like this:</p>
<pre><code class="language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZuulConfig</span> </span>{

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ZuulFilter <span class="hljs-title">sentinelZuulPreFilter</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// We can provider the filter order here.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelZuulPreFilter(<span class="hljs-number">10000</span>);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ZuulFilter <span class="hljs-title">sentinelZuulPostFilter</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelZuulPostFilter(<span class="hljs-number">1000</span>);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ZuulFilter <span class="hljs-title">sentinelZuulErrorFilter</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelZuulErrorFilter(-<span class="hljs-number">1</span>);
    }
}
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/sentinel_gray.png"/><div class="cols-container"><div class="col col-12"><h3>Disclaimer</h3><p>Sentinel is an open-source project under Apache License 2.0.</p></div><div class="col col-6"><dl><dt>Documentation</dt><dd><a href="/en-us/docs/introduction.html" target="_self">Overview</a></dd><dd><a href="/en-us/docs/quick-start.html" target="_self">Quick start</a></dd><dd><a href="/en-us/docs/contribution/contribution-guideline.html" target="_self">Developer guide</a></dd></dl></div><div class="col col-6"><dl><dt>Resources</dt><dd><a href="/en-us/blog/index.html" target="_self">Blog</a></dd><dd><a href="/en-us/community/index.html" target="_self">Community</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 - 2020 The Sentinel Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>